{{ 'section-quiz.css' | asset_url | stylesheet_tag: preload: true }}

{% style %}
  #shopify-section-{{ section.id }}{
    background-color:{{section.settings.bg_color }};
    color:{{section.settings.text_color }};
  }

    #shopify-section-{{ section.id }} .questionnaire-wrapper{
       padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
       padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
       height:100%;
    }


    .reveal-target {
      display: none;
    }

    .reveal-target.visible {
      display: block;
    }

    @media screen and (min-width: 750px) {
      #shopify-section-{{ section.id }} .questionnaire-wrapper{
       padding-top: {{ section.settings.padding_top }}px;
       padding-bottom: {{ section.settings.padding_bottom }}px;
    }

    }
{% endstyle %}
<div id="{{ section.id }}" class="main-questionnaire-wrapper">
  <div class="questionnaire-wrapper reveal-target page-width">
    <!-- Progress Bar -->
    <div class="step-progress" id="stepProgress">
      {% for block in section.blocks %}
        <div class="step" data-step="{{ forloop.index0 }}">{{ forloop.index }}</div>
      {% endfor %}
    </div>

    <!-- Question Blocks -->
    {% for block in section.blocks %}
      <div
        class="question-block {% if forloop.first %}visible{% endif %}"
        id="question-{{ forloop.index0 }}"
        data-step="{{ forloop.index0 }}"
      >
        <h2 class="h1">{{ block.settings.question_heading }}</h2>
        <div class="answer-buttons">
          <button class="answer-btn">{{ block.settings.answer_1 }}</button>
          <button class="answer-btn">{{ block.settings.answer_2 }}</button>
          <button class="answer-btn">{{ block.settings.answer_3 }}</button>
          <button class="answer-btn">{{ block.settings.answer_4 }}</button>
        </div>
      </div>
    {% endfor %}
    <div class="short-text typeset0">{{ section.settings.short_txt }}</div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const blocks = document.querySelectorAll('.question-block');
    const steps = document.querySelectorAll('.step');
    const redirectUrl = '{{ section.settings.redirect_url }}';

    function updateProgress(index) {
      steps.forEach((step, i) => {
        if (i <= index) {
          step.classList.add('active');
        } else {
          step.classList.remove('active');
        }
      });
    }

    blocks.forEach((block, index) => {
      const buttons = block.querySelectorAll('.answer-btn');

      buttons.forEach((button) => {
        button.addEventListener('click', () => {
          const fadeDuration = 500;

          const isLastQuestion = index + 1 >= blocks.length;

          if (!isLastQuestion) {
            // Fade out current block
            block.classList.remove('visible');
            block.classList.add('fade-out');

            const nextBlock = blocks[index + 1];

            // Prepare and fade in next block
            nextBlock.classList.remove('hidden');
            nextBlock.classList.add('pre-visible');
            void nextBlock.offsetWidth; // Force reflow
            nextBlock.classList.remove('pre-visible');
            nextBlock.classList.add('visible');

            // Update progress UI
            updateProgress(index + 1);

            // Fully hide the previous block after fade-out
            setTimeout(() => {
              block.classList.remove('fade-out');
              block.classList.add('hidden');
            }, fadeDuration);
          } else {
            // LAST QUESTION â†’ no fade out, keep visible
            updateProgress(index);

            // Optional: show a "Redirecting..." message or spinner here

            setTimeout(() => {
              window.location.href = redirectUrl;
            }, fadeDuration);
          }
        });
      });
    });

    // Initial step highlight
    updateProgress(0);
  });
</script>

{% schema %}
{
  "name": "Quiz Section",
  "settings": [
    {
      "type": "richtext",
      "id": "quiz_heading",
      "label": "Heading"
    },
    {
      "type": "url",
      "id": "redirect_url",
      "label": "Final Redirect URL",
      "default": "/"
    },
    {
      "type": "header",
      "content": "Color"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color"
    },
    {
      "type": "richtext",
      "id": "short_txt",
      "label": "Disclaimer"
    },
    {
      "type": "header",
      "content": "Padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding Top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 36
    }
  ],
  "blocks": [
    {
      "type": "question",
      "name": "Question Block",
      "settings": [
        {
          "type": "text",
          "id": "question_heading",
          "label": "Question Heading"
        },
        {
          "type": "text",
          "id": "answer_1",
          "label": "Answer 1"
        },
        {
          "type": "text",
          "id": "answer_2",
          "label": "Answer 2"
        },
        {
          "type": "text",
          "id": "answer_3",
          "label": "Answer 3"
        },
        {
          "type": "text",
          "id": "answer_4",
          "label": "Answer 4"
        }
      ]
    }
  ],
  "max_blocks": 3,
  "presets": [
    {
      "name": "Quiz Section"
    }
  ]
}
{% endschema %}
